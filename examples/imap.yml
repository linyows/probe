name: Email Authentication Flow
description: Retrieve authentication codes and verification links from email

vars:
  host: "{{MAIL_HOST ?? 'imap.gmail.com'}}"
  user: "{{MAIL_USER}}"
  pass: "{{MAIL_PASS}}"
  port: "{{MAIL_PORT ?? 993}}"
  smtp_host: "{{SMTP_HOST ?? MAIL_HOST ?? 'localhost'}}"
  smtp_port: "{{SMTP_PORT ?? 3025}}"
  mail_setup: "{{MAIL_SETUP ?? ''}}"
  tls_enabled: "{{TLS_ENABLED ?? 'true'}}"
  mail_to: "{{MAIL_TO ?? MAIL_USER}}"
  skip_search_tests: "{{SKIP_SEARCH_TESTS ?? ''}}"

jobs:
- name: Email Authentication
  defaults:
    imap:
      host: "{{vars.host}}"
      port: "{{vars.port}}"
      username: "{{vars.user}}"
      password: "{{vars.pass}}"
      tls: "{{vars.tls_enabled == 'true'}}"
  steps:
  - name: Send test emails for IMAP testing
    uses: smtp
    with:
      addr: "{{vars.smtp_host}}:{{vars.smtp_port}}"
      from: "sender@example.com"
      to: "{{vars.mail_to}}"
      subject: Test Email for IMAP
      myhostname: probe-test.local
      session: 1
      message: 5
      length: 1000
    skipif: vars.mail_setup == ''
    test: |
      res.code == 0 && res.sent == 5
    echo: |
      Test emails sent: {{res.sent}}
  # Wait is necessary to ensure mail server completes asynchronous processing
  # (receiving emails and placing them into mailbox) before IMAP operations
  - name: Wait mail receiving
    uses: hello
    skipif: vars.mail_setup == ''
    wait: 1s

  - name: List
    uses: imap
    with:
      commands:
      - name: list
        reference: "INBOX"
        pattern: "*"
    test: status == 0
    echo: |
      List: {{res.data.list.mailboxes}}

  - name: Select to INBOX
    uses: imap
    with:
      commands:
      - name: select
        mailbox: INBOX
    test: status == 0
    echo: |
      INBOX Count: {{res.data.select.exists}}

  - name: UID Search on INBOX
    uses: imap
    with:
      commands:
      - name: select
        mailbox: INBOX
      - name: uid search
        criteria:
          #before: 2025-01-01
          flags: [seen]
          #not_flags: [seen]
    skipif: vars.skip_search_tests != ''
    test: status == 0
    echo: |
      Search: {{res.data.search}}

  - name: UID Fetch after UID Search
    uses: imap
    with:
      commands:
      - name: select
        mailbox: INBOX
      - name: uid search
        criteria:
          flags: [seen]
      - name: uid fetch
    skipif: vars.skip_search_tests != ''
    test: status == 0 && len(res.data.fetch.messages) > 0
    echo: |
      Subject: {{res.data.fetch.messages[0].subject}}
      From: {{res.data.fetch.messages[0].from}}
      To: {{res.data.fetch.messages[0].to}}
      Flags: {{res.data.fetch.messages[0].flags}}
      Size: {{res.data.fetch.messages[0].size}}

  - name: UID Fetch Return-Path Header after UID Search
    uses: imap
    with:
      commands:
      - name: select
        mailbox: INBOX
      - name: uid search
        criteria:
          flags: [seen]
      - name: uid fetch
        dataitem: "BODY[HEADER.FIELDS (Return-Path)]"
    skipif: vars.skip_search_tests != ''
    test: status == 0 && len(res.data.fetch.messages) > 0
    echo: |
      Headers: {{res.data.fetch.messages[0].headers}}

  - name: Get error
    uses: imap
    with:
      commands:
      - name: search
        criteria:
          bodies: ["@@@nothing@@@"]
      - name: uid fetch
        dataitem: all
    test: status == 1
    echo: |
      Error: {{res.error}}
