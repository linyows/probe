name: End-to-end Testing

on:
  workflow_dispatch:
    inputs:
      options:
        description: 'Additional options for probe (e.g., --verbose)'
        required: false
        default: ''
        type: string
  push:
    branches: [main]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
  issue_comment:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.ref }}
  cancel-in-progress: false

permissions:
  contents: 'read'
  id-token: 'write'
  pull-requests: 'write'

jobs:
  test:
    name: Verify all examples
    runs-on: ubuntu-latest
    # Run if:
    # 1. push to main or workflow_dispatch
    # 2. issue_comment with '/run-e2e' from maintainer on a PR
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/run-e2e') &&
       (github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
    steps:
    - name: Get PR info for comment trigger
      if: github.event_name == 'issue_comment'
      id: pr
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          core.setOutput('ref', `refs/pull/${context.issue.number}/head`);
          core.setOutput('sha', pr.head.sha);

    - name: Add reaction to comment
      if: github.event_name == 'issue_comment'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          await github.rest.reactions.createForIssueComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: context.payload.comment.id,
            content: 'rocket'
          });

    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        ref: ${{ steps.pr.outputs.sha || github.sha }}

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y protobuf-compiler xvfb x11-utils
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@b94431e051d1c52dcbe9a7092a4f10f827795416 # latest
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Setup go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version-file: go.mod
    - name: Run probe
      uses: linyows/probe-action@0164e23555aacbaaea03169102262dafeb1ff631 # v1
      with:
        path: testdata/e2e-test.yml
        options: ${{ github.event.inputs.options }}

    - name: Comment on success
      if: success() && github.event_name == 'issue_comment'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: '✅ E2E test passed successfully!'
          });

    - name: Comment on failure
      if: failure() && github.event_name == 'issue_comment'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `❌ E2E test failed. [View logs](${runUrl})`
          });
